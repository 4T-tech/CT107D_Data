C51 COMPILER V9.56.0.0   MAIN                                                              01/24/2025 19:47:31 PAGE 1   


C51 COMPILER V9.56.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Driver) DEFINE(PCF8591) DEBUG 
                    -OBJECTEXTEND PRINT(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include "tim.h"
   2          #include "seg.h"
   3          #include <stdio.h>
   4          #include "key.h"
   5          #include "ds18b20.h"
   6          #include "i2c.h"
   7          
   8          unsigned char ucState;              // 系统状态
   9          unsigned int  uiTemp;               // 温度值(*16)
  10          unsigned int  uiDac;                // DAC值(*100)
  11          unsigned char ucPara=25, ucPara1=25;  // 温度参数： 在退出参数设置界面时生效
  12          
  13          void Seg_Proc(void);
  14          void Key_Proc(void);
  15          void Data_Proc(void);
  16          
  17          void main(void)
  18          {
  19   1        Close_Peripheral();
  20   1        T1_Init();
  21   1      
  22   1        while(1)
  23   1        {
  24   2          Seg_Proc();
  25   2          Key_Proc();
  26   2          Data_Proc();
  27   2        }
  28   1      }
  29          
  30          unsigned char pucSeg_Char[12];      // 显示字符
  31          unsigned char pucSeg_Code[8];       // 显示代码
  32          unsigned char ucSeg_Pos;            // 显示位置
  33          unsigned int  uiSeg_Dly;            // 显示刷新延时
  34          unsigned char ucSeg_Dly;            // 显示移位延时
  35          void Seg_Proc(void)
  36          {
  37   1        if (uiSeg_Dly > 300)              // 300ms刷新1次
  38   1        {
  39   2          uiSeg_Dly = 0;
  40   2      
  41   2          switch(ucState)
  42   2          {
  43   3            case 0:                       // 温度显示
  44   3              sprintf(pucSeg_Char, "C   %04.2f", uiTemp/16.0);
  45   3              break;
  46   3            case 1:                       // 参数显示
  47   3              sprintf(pucSeg_Char, "P     %02u", (int)ucPara1);
  48   3              break;
  49   3            case 2:                       // DAC显示
  50   3              sprintf(pucSeg_Char, "A    %03.2f", uiDac/100.0);
  51   3          }
  52   2          Seg_Tran(pucSeg_Char, pucSeg_Code);
  53   2        }
  54   1        if (ucSeg_Dly >= 2)               // 2ms移位1次
C51 COMPILER V9.56.0.0   MAIN                                                              01/24/2025 19:47:31 PAGE 2   

  55   1        {
  56   2          ucSeg_Dly = 0;
  57   2      
  58   2          Seg_Disp(pucSeg_Code[ucSeg_Pos], ucSeg_Pos);
  59   2          ucSeg_Pos = ++ucSeg_Pos & 7;    // 数码管循环显示
  60   2        }
  61   1      }
  62          
  63          unsigned char ucKey_Old;            // 旧键值
  64          unsigned char ucKey_Dly;            // 按键刷新延时
  65          unsigned char ucLed=3;              // LED值：模式1（L1点亮），温度显示（L2点亮）
  66          void Key_Proc(void)
  67          {
  68   1        unsigned char ucKey_Dn;           // 按下键值
  69   1      
  70   1        if(ucKey_Dly < 10)                // 延时10ms消抖
  71   1          return;
  72   1        ucKey_Dly = 0;
  73   1      
  74   1        ucKey_Dn = Key_Read();            // 键值读取
  75   1        if (ucKey_Dn != ucKey_Old)        // 键值变化
  76   1        {
  77   2          ucKey_Old = ucKey_Dn;
  78   2        } else {
  79   2          ucKey_Dn = 0;
  80   2        }
  81   1      
  82   1        switch (ucKey_Dn)
  83   1        {
  84   2          case 4:                         // S4
  85   2            if(++ucState == 3)            // 循环切换状态
  86   2              ucState = 0;
  87   2            if(ucState == 2)              // 设定的温度参数在退出参数设置界面时生效
  88   2              ucPara = ucPara1;
  89   2            ucLed &= 1;
  90   2            ucLed |= 1 << ucState+1;      // 设置LED指示
  91   2            break;
  92   2          case 5:                         // S5
  93   2            ucLed ^= 1;                   // 切换模式（LED1）
  94   2            break;
  95   2          case 8:                         // S8
  96   2            if(ucState == 1)              // S8按键仅在参数设置界面有效
  97   2              if(ucPara1 != 0)
  98   2                ucPara1--;
  99   2            break;
 100   2          case 9:                         // S9
 101   2            if(ucState == 1)              // S9按键仅在参数设置界面有效
 102   2              ucPara1++;
 103   2        }
 104   1        Led_Disp(ucLed);
 105   1      }
 106          
 107          unsigned int  uiData_Dly;           // 数据采集延时
 108          void Data_Proc(void)
 109          {
 110   1        unsigned char ucTemp;
 111   1      
 112   1        if (uiData_Dly < 400)             // 400ms时间未到
 113   1          return;
 114   1        uiData_Dly = 0;
 115   1      
 116   1        uiTemp = Temp_Read();             // 读取温度
C51 COMPILER V9.56.0.0   MAIN                                                              01/24/2025 19:47:31 PAGE 3   

 117   1        ucTemp = uiTemp >> 4;             // 整数部分
 118   1      
 119   1        if((ucLed & 1) == 1)              // 模式1
 120   1        {
 121   2          if(ucTemp < ucPara)
 122   2            uiDac = 0;                    // 0V
 123   2          else
 124   2            uiDac = 500;                  // 5V
 125   2        }
 126   1        else                              // 模式2
 127   1        {
 128   2          if(ucTemp < 20)
 129   2            uiDac = 100;                  // 1V
 130   2          else if(ucTemp >= 40)
 131   2            uiDac = 400;                  // 4V
 132   2          else
 133   2            uiDac = (ucTemp * 15) - 200;
 134   2        }
 135   1        PCF8591_Dac(uiDac * 0.51);        // 255/500
 136   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    425    ----
   CONSTANT SIZE    =     34    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     36    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
